# Интеллектуальный Мультибанковский Финансовый Советник (ИМФС)

Наш проект — это не просто очередной финансовый агрегатор. Это ваш персональный финансовый советник с искусственным интеллектом, созданный для того, чтобы дать вам полный контроль над вашими финансами и помочь принимать взвешенные решения.

## Почему наше решение — лучшее?

Мы решаем главную проблему современного банкинга — фрагментацию данных. Ваши счета, карты и транзакции разбросаны по разным приложениям, не давая увидеть полную картину. ИМФС объединяет все на одном экране и превращает сухие цифры в ценные знания.

**Ключевые преимущества:**

- **Единый центр управления:** Подключите счета из нескольких ведущих банков (VBank, ABank, SBank) и управляйте ими из одного интуитивно понятного интерфейса.
- **Аналитика на базе ИИ:** Система автоматически категоризирует ваши траты, выявляет паттерны и помогает понять, куда на самом деле уходят ваши деньги.
- **Персональные советы:** На основе анализа ваших данных ИМФС дает конкретные рекомендации: от оптимизации подписок до советов по накоплению и инвестированию.
- **Безопасность прежде всего:** Мы используем современные стандарты шифрования (включая сквозное шифрование для токенов доступа) и работаем в строгом соответствии со стандартами OpenBanking.
- **Готовность к будущему:** Наша архитектура легко расширяется для подключения новых банков и финансовых сервисов.

## Технологический стек Бэкенда

- **Бэкенд:** Python 3.11+ / FastAPI
- **База данных:** PostgreSQL (рекомендуется), SQLite (для простоты запуска)
- **Взаимодействие с API:** `httpx` для асинхронных запросов
- **Безопасность:** `cryptography` для шифрования, `pydantic` для валидации данных

## Технологический стек UI

-   **Фреймворк:** React 19
-   **Язык:** TypeScript
-   **Стилизация:** Tailwind CSS
-   **AI:** Google AI
-   **Графики:** Recharts

## Быстрый старт

### 1. Установка зависимостей

Убедитесь, что у вас установлен `uv` (сверхбыстрый менеджер пакетов для Python).

```bash
uv pip sync pyproject.toml
```

### 2. Настройка переменных окружения

Создайте файл `.env` в корне проекта. Он должен содержать:

```
CLIENT_ID=your_client_id
CLIENT_SECRET=your_client_secret
ENCRYPTION_KEY=your_32_byte_long_encryption_key
DATABASE_URL=sqlite:///./app.db
```

- `CLIENT_ID`, `CLIENT_SECRET`: Ваши учетные данные для API банков.
- `ENCRYPTION_KEY`: Ключ для шифрования. **Сгенерируйте его командой:**
  ```bash
  python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
  ```
- `DATABASE_URL`: URL для подключения к базе данных.

### 3. Запуск приложения

```bash
uvicorn main:app --reload
```

Сервер будет доступен по адресу `http://127.0.0.1:8000`. Документация OpenAPI (Swagger) — по адресу `http://127.0.0.1:8000/docs`.

## Как проверить работоспособность (workflow)

После запуска приложения вы можете проверить базовый сценарий с помощью `curl`.

**Шаг 1: Инициализация токенов**

Эта команда получит и сохранит в зашифрованном виде токены для всех банков.

```bash
curl -X POST http://127.0.0.1:8000/api/v1/auth/init-bank-tokens -H "Content-Length: 0"
```

**Шаг 2: Создание согласия на доступ к счетам**

Создадим согласие для `vbank`. Это позволит нам читать данные пользователя `team042-1`.

```bash
curl -X POST http://127.0.0.1:8000/api/v1/auth/create-consent -H "Content-Type: application/json" -d \
'{' \
  "bank_name": "vbank",' \
  "user_id": "team042-1",' \
  "permissions": ["ReadAccountsDetail", "ReadBalances"]' \
}'
```

В ответе вы получите `consent_id`. Скопируйте его для следующего шага.

**Шаг 3: Получение списка счетов**

Используем полученный `consent_id` для запроса счетов.

```bash
# Замените ВАШ_CONSENT_ID на ID из предыдущего шага
curl -X POST http://127.0.0.1:8000/api/v1/data/accounts/list -H "Content-Type: application/json" -d \
'{' \
  "bank_name": "vbank",' \
  "consent_id": "ВАШ_CONSENT_ID",' \
  "user_id": "team042-1"' \
}'
```

Если все шаги прошли успешно, вы увидите список счетов. Это подтверждает, что ядро системы работает корректно!

## Запуск тестов

Для полного прогона тестов (часть из них будет пропущена с объяснением причин) выполните:

```bash
PYTHONPATH=. pytest -sv tests/
```

## Важные особенности API банков (по итогам тестов)

В ходе интеграции были выявлены следующие особенности API, которые важно учитывать:

- **VBank & ABank:**
  - **Платежи:** Создание платежа возвращает ошибку `403 Forbidden` с сообщением о несоответствии суммы, даже если суммы идентичны. Это **вероятный баг "песочницы"** данных банков.
  - **Управление платежными согласиями:** Попытки получить (`GET`) или отозвать (`DELETE`) созданное платежное согласие приводят к ошибке `401 Unauthorized`. Это с высокой вероятностью указывает на **требование mTLS** для этих эндпоинтов.
  - **Управление согласиями на продукты:** Создание согласия на управление договорами продуктов (`POST /product-agreement-consents/request`) постоянно возвращает ошибку `422 Unprocessable Entity`. Это **вероятный баг "песочницы"** или недокументированные требования API.

- **SBank:**
  - **Любые согласия:** Создание любого типа согласия требует **ручного подтверждения** со стороны пользователя. API возвращает статус `pending`. Это делает невозможным проведение автоматических сквозных тестов.

- **Все банки:**
  - **Управление счетами:** Эндпоинты для прямого управления счетами (создание, изменение статуса) требуют другого типа аутентификации (`client_token`) и в данный момент не используются в основном workflow.

## Справка по API

Ниже представлено описание ключевых эндпоинтов, доступных в сервисе.

### Аутентификация и Согласия

- `POST /api/v1/auth/init-bank-tokens`: Инициализация токенов.
- `POST /api/v1/auth/create-consent`: Создание согласия на доступ к данным.
- `POST /api/v1/payments/payment-consents`: Создание согласия на **платеж**.
- `GET /api/v1/auth/consents/{id}`: Получение информации о согласии на **доступ**.
- `DELETE /api/v1/auth/consents/{id}`: Отзыв согласия на **доступ**.

### Данные

- `POST /api/v1/data/accounts/list`: Получение списка счетов.
- `POST /api/v1/data/accounts/{id}/balances`: Получение балансов счета.
- `POST /api/v1/data/accounts/{id}/transactions`: Получение транзакций счета.

### Платежи

- `POST /api/v1/payments/{bank_name}/create`: Создание нового платежа.
- `GET /api/v1/payments/{bank_name}/{id}/status`: Получение статуса платежа.
- `GET /api/v1/payments/payment-consents/{id}`: Получение информации о согласии на **платеж**.
- `DELETE /api/v1/payments/payment-consents/{id}`: Отзыв согласия на **платеж**.

### Продукты

- `GET /api/v1/products/products`: Получение каталога банковских продуктов.
- `GET /api/v1/products/products/{product_id}`: Получение деталей продукта.
- `POST /api/v1/products/product-agreement-consents/request`: Создание согласия на управление договорами продуктов.
- `GET /api/v1/products/product-agreement-consents/{consent_id}`: Получение деталей согласия на управление договорами продуктов.
- `DELETE /api/v1/products/product-agreement-consents/{consent_id}`: Отзыв согласия на управление договорами продуктов.
- `GET /api/v1/products/product-agreements`: Получение списка договоров клиента по продуктам.
- `POST /api/v1/products/product-agreements`: Открытие нового продукта (создание договора).
- `GET /api/v1/products/product-agreements/{agreement_id}`: Получение деталей конкретного договора по продукту.
- `DELETE /api/v1/products/product-agreements/{agreement_id}`: Закрытие (расторжение) договора по продукту.
